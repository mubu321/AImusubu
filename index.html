<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚€ã™ã¶AI ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9fafc; color: #212121; margin: 0; }
    header { background: #27c6e9; color: #fff; padding: 16px; text-align: center; font-size: 1.5em; letter-spacing: 2px; }
    #status { color: #0e74b7; margin: 10px 0; text-align: center; }
    #ai-info {
      background: #f0ffea;
      border-left: 5px solid #27c6e9;
      color: #0e74b7;
      margin: 0 12px 10px 12px;
      padding: 10px 16px 10px 14px;
      border-radius: 7px;
      font-size: 1.01em;
      font-weight: 500;
      box-shadow: 0 1px 4px #ddddff3a;
    }
    #log { background: #fff; height: 400px; overflow-y: auto; padding: 16px; margin: 12px; border-radius: 8px; border: 1px solid #e0e0e0; }
    .ai { background: #e7f3ff; margin: 8px 0; padding: 8px 12px; border-radius: 8px; text-align: left; color: #0e74b7; }
    .user { background: #c6f1e7; margin: 8px 0; padding: 8px 12px; border-radius: 8px; text-align: right; color: #187d69; }
    #inputArea { display: flex; gap: 8px; margin: 12px; }
    #msg { flex: 1; font-size: 1em; padding: 8px; border-radius: 4px; background: #f1f9fa; color: #212121; border: 1px solid #b2e0eb; }
    #send { padding: 8px 20px; font-size: 1em; background: #27c6e9; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    #send:disabled { background: #bbb; cursor: not-allowed; }
    #sdpArea { margin: 12px; }
    textarea { width: 100%; height: 80px; margin-top: 4px; background: #f1f9fa; color: #0e74b7; border: 1px solid #b2e0eb; border-radius: 4px; }
    .ai-label {
      background: #27c6e9;
      color: #fff;
      padding: 2px 10px;
      border-radius: 6px;
      font-size: 0.9em;
      margin-left: 7px;
      letter-spacing: 0.05em;
      vertical-align: middle;
    }
    .obf-label {
      font-family: 'Cascadia Code', 'Consolas', monospace;
      color: #0e74b7;
      font-size: 1.05em;
      letter-spacing: 0.03em;
      background: #e7f3ff;
      padding: 2px 6px;
      border-radius: 5px;
      margin-bottom: 5px;
      display: inline-block;
    }
    .sdp-tip {
      color: #2dbe60;
      font-size: 0.96em;
      margin-bottom: 2px;
    }
    #autoAuth {
      color: #2dbe60;
      font-size: 0.98em;
      margin-bottom: 4px;
    }
    #clearAuthBtn {
      font-size: 0.9em;
      background: #eee;
      color: #27c6e9;
      border: 1px solid #27c6e9;
      border-radius: 5px;
      padding: 2px 10px;
      margin-left: 10px;
      cursor: pointer;
    }
    #clearAuthBtn:hover {
      background: #e7f3ff;
    }
  </style>
</head>
<body>
  <header>ğŸ¤– ã‚€ã™ã¶AI ãƒãƒ£ãƒƒãƒˆ <span class="ai-label">ã‚€ã™ã¶AIã¨å®‰å…¨é€šä¿¡ä¸­</span></header>
  <div id="status">ã‚€ã™ã¶AIã¨ä¼šè©±ã—ã¦ã„ã¾ã™</div>
  <div id="ai-info">
    <strong>ã‚€ã™ã¶AIã‚·ã‚¹ãƒ†ãƒ ã¨å®‰å…¨ã«é€šä¿¡ã—ã¦ã„ã¾ã™ã€‚</strong><br>
    <span style="font-size:0.97em;">
      ã‚€ã™ã¶AIã¯ã‚ãªãŸã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è‡ªå‹•å¿œç­”ã—ã¾ã™ã€‚<br>
      æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯èªè¨¼æ¸ˆã¿AIå°‚ç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
    </span>
  </div>
  <div id="log"></div>
  <div id="inputArea">
    <input id="msg" type="text" placeholder="ã‚€ã™ã¶AIã«é€ä¿¡..." disabled>
    <button id="send" disabled>é€ä¿¡</button>
  </div>
  <div id="sdpArea">
    <div class="obf-label">èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</div><br>
    <div class="sdp-tip">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚€ã™ã¶AIå´ã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</div>
    <textarea id="localSDP" readonly></textarea>
    <div class="obf-label" style="margin-top:11px;">ã‚€ã™ã¶AIæ¥ç¶šã‚­ãƒ¼ï¼ˆAI SYSTEM ENCODEDï¼‰</div><br>
    <div class="sdp-tip">ã‚€ã™ã¶AIã‹ã‚‰å—ã‘å–ã£ãŸæ¥ç¶šã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œã‚»ãƒƒãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="autoAuth" style="display:none;">å‰å›ã®ã‚€ã™ã¶AIæ¥ç¶šã‚­ãƒ¼ã‚’è‡ªå‹•ã§é©ç”¨ã—ã¾ã—ãŸã€‚</div>
    <textarea id="remoteSDP"></textarea>
    <button id="setRemote">ã‚»ãƒƒãƒˆ</button>
    <button id="clearAuthBtn" style="display:none;">æ¥ç¶šã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
  <script>
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const msg = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const localSDP = document.getElementById('localSDP');
    const remoteSDP = document.getElementById('remoteSDP');
    const setRemote = document.getElementById('setRemote');
    const autoAuth = document.getElementById('autoAuth');
    const clearAuthBtn = document.getElementById('clearAuthBtn');

    let pc, dc;

    // é›£èª­åŒ–é–¢æ•°ï¼ˆBase64â†’ROT13â†’AIé¢¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸ï¼‰
    function obfuscate(str) {
      const b64 = btoa(unescape(encodeURIComponent(str)));
      const rot13 = b64.replace(/[A-Za-z]/g, c =>
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".charAt(
          ("NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm").indexOf(c)
        )
      );
      // AIé¢¨ã®prefix/suffixã§åŒ…ã‚€
      const prefix = "MUSUBUAI{";
      const suffix = "}END";
      return prefix + rot13 + suffix;
    }
    // å¾©å·é–¢æ•°
    function deobfuscate(str) {
      if (!str.startsWith("MUSUBUAI{") || !str.endsWith("}END")) return null;
      const rot13 = str.slice(9, -4);
      const b64 = rot13.replace(/[A-Za-z]/g, c =>
        "NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm".charAt(
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".indexOf(c)
        )
      );
      try {
        return decodeURIComponent(escape(atob(b64)));
      } catch {
        return null;
      }
    }

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = sender;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    async function start() {
      pc = new RTCPeerConnection();
      dc = pc.createDataChannel("chat");
      dc.onopen = () => {
        status.textContent = "ã‚€ã™ã¶AIã¨æ¥ç¶šã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ£ãƒƒãƒˆã§ãã¾ã™";
        msg.disabled = false;
        sendBtn.disabled = false;
        msg.disabled = false;
        sendBtn.disabled = false;
      };
      dc.onmessage = (event) => {
        // ã‚€ã™ã¶AIã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        addMessage(event.data, 'ai');
      };

      pc.onicecandidate = () => {
        localSDP.value = obfuscate(JSON.stringify(pc.localDescription));
      };

      await pc.setLocalDescription(await pc.createOffer());
      localSDP.value = obfuscate(JSON.stringify(pc.localDescription));
    }

    sendBtn.onclick = () => {
      if (msg.value && dc && dc.readyState === 'open') {
        addMessage(msg.value, 'user');
        dc.send(msg.value);
        msg.value = '';
      }
    };

    msg.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    setRemote.onclick = async () => {
      if (!remoteSDP.value) return;
      const decoded = deobfuscate(remoteSDP.value);
      if (!decoded) {
        alert("ã‚€ã™ã¶AIæ¥ç¶šã‚­ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆMUSUBUAI{...}ENDï¼‰");
        return;
      }
      const sdp = JSON.parse(decoded);
      await pc.setRemoteDescription(sdp);

      // ã‚­ãƒ¼ã‚’ä¿å­˜
      try {
        localStorage.setItem("lastMusubuAIKey", remoteSDP.value);
        showAutoAuthUI();
      } catch {}
    };

    function showAutoAuthUI() {
      autoAuth.style.display = "inline";
      clearAuthBtn.style.display = "inline";
    }
    function hideAutoAuthUI() {
      autoAuth.style.display = "none";
      clearAuthBtn.style.display = "none";
    }

    clearAuthBtn.onclick = () => {
      localStorage.removeItem("lastMusubuAIKey");
      remoteSDP.value = "";
      hideAutoAuthUI();
    };

    // èµ·å‹•æ™‚: å‰å›èªè¨¼æƒ…å ±ãŒã‚ã‚Œã°è‡ªå‹•
    (async function(){
      await start();

      const lastMusubuAIKey = localStorage.getItem("lastMusubuAIKey");
      if (lastMusubuAIKey) {
        remoteSDP.value = lastMusubuAIKey;
        showAutoAuthUI();
        setTimeout(() => setRemote.click(), 300);
      }
    })();
  </script>
</body>
</html>